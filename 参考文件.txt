import React, { useState, useCallback, useMemo } from 'react';
import { Clipboard, Send, Loader, Zap, Users, Monitor, Sparkles, Meh, Laugh, BookOpen, Image, Download, RefreshCw, Target } from 'lucide-react';

// --- å…¨å±€é…ç½®ä¸æ•°æ® ---

// æ¨¡æ‹Ÿ Firebase é…ç½®å’Œ Auth (Canvasè¦æ±‚ï¼Œå³ä½¿MVPä¸ç”¨ä¹Ÿè¦åŒ…å«)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// AI API é…ç½®
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
const IMAGEN_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict';
const apiKey = ""; // API key will be provided by the Canvas environment

// ç›®æ ‡å¹³å°é…ç½® (F-02, F-06, F-07) - å·²é›†æˆ Prompt ç­–ç•¥
const PLATFORMS = [
  { id: 'twitter', name: 'X/Twitter', icon: Users, limit: 280, color: 'bg-blue-600', max: '280 å­—ç¬¦', prompt: "ç›®æ ‡æ˜¯ X/Twitterï¼Œæ–‡æ¡ˆå¿…é¡»åœ¨ 280 å­—ç¬¦å†…å®Œæˆã€‚ä½¿ç”¨ç®€çŸ­çš„å¥å­å’Œæœ€å¤š 3 ä¸ªå¼ºç›¸å…³ Hashtagã€‚" },
  { id: 'instagram', name: 'Instagram', icon: Monitor, limit: 2200, color: 'bg-pink-600', max: '2200 å­—ç¬¦', prompt: "ç›®æ ‡æ˜¯ Instagram Captionï¼Œå­—ç¬¦é™åˆ¶å®½æ¾ï¼Œä½†å¿…é¡»ä½¿ç”¨å¤šæ®µæ¢è¡Œå’Œå¤§é‡çš„ Emoji æ¥å¢åŠ æ’ç‰ˆç¾è§‚åº¦ã€‚æ–‡æ¡ˆç»“å°¾æ·»åŠ æ˜ç¡®çš„ CTAã€‚" },
  { id: 'linkedin', name: 'LinkedIn', icon: BookOpen, limit: 3000, color: 'bg-sky-700', max: '3000 å­—ç¬¦', prompt: "ç›®æ ‡æ˜¯ LinkedIn Postã€‚æ–‡æ¡ˆå¿…é¡»å…·æœ‰ä¸“ä¸šæ€§ã€æƒå¨æ€§ï¼Œè¯­æ°”æ­£å¼ã€‚ä½¿ç”¨ 5-7 ä¸ªå…³é”®ç‚¹åˆ—è¡¨æ ¼å¼æ¥ç»„ç»‡å†…å®¹ï¼Œé¼“åŠ±ä¸“ä¸šäººå£«äº’åŠ¨ã€‚" },
  { id: 'xiaohongshu', name: 'å°çº¢ä¹¦', icon: Sparkles, limit: 1000, color: 'bg-red-500', max: '1000 å­—', prompt: "ç›®æ ‡æ˜¯å°çº¢ä¹¦ç¬”è®°ã€‚å¿…é¡»ä½¿ç”¨ç§è‰ã€åˆ†äº«çš„å£å»ï¼Œå¼€å¤´ä½¿ç”¨å¸å¼•çœ¼çƒçš„æ ‡é¢˜æˆ–è¡¨æƒ…ç¬¦å·ï¼Œå†…å®¹åˆ†æ®µï¼Œå¹¶ä½¿ç”¨å°çº¢ä¹¦å¸¸ç”¨çš„ Hashtag æ ¼å¼ã€‚" },
];

// æ–‡æ¡ˆè¯­æ°”é…ç½® (F-03) - å·²é›†æˆ Prompt ç­–ç•¥
const TONES = [
  { id: 'professional', name: 'ä¸“ä¸š (Professional)', icon: Zap, prompt: "è¯·ä½¿ç”¨**ä¸“ä¸šã€æ­£å¼**çš„è¯­æ°”ã€‚ä¿æŒå®¢è§‚ï¼Œé¿å…ä½¿ç”¨å¤¸å¼ çš„è¡¨æƒ…ç¬¦å·ã€‚" },
  { id: 'humorous', name: 'å¹½é»˜ (Humorous)', icon: Laugh, prompt: "è¯·ä½¿ç”¨**å¹½é»˜ã€é£è¶£**çš„è¯­æ°”ã€‚ç”¨è½»æ¾çš„å£å»è®²è¿°å†…å®¹ï¼Œå¯ä»¥é€‚åº¦åŠ å…¥æµè¡Œçš„ç½‘ç»œæ¢—å’Œè¡¨æƒ…ç¬¦å·ã€‚" },
  { id: 'concise', name: 'ç®€æ´ (Concise)', icon: Meh, prompt: "è¯·ä½¿ç”¨**ç®€æ´ã€é«˜æ•ˆ**çš„è¯­æ°”ã€‚ç›´æ¥æå–å†…å®¹ä¸­çš„ 1-2 ä¸ªæ ¸å¿ƒäº®ç‚¹ï¼Œç”¨æœ€çŸ­çš„æ–‡å­—è¡¨è¾¾æ¸…æ¥šã€‚" },
];

// --- è¾…åŠ©å‡½æ•°ï¼šAI API è°ƒç”¨ ---

/**
 * æ ¸å¿ƒ AI è°ƒç”¨å‡½æ•°ï¼Œè´Ÿè´£æ„å»º Prompt å’Œè°ƒç”¨ Gemini APIã€‚
 * å®ç°äº†æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶ã€‚
 */
const generateCopyWithGemini = async (content, platform, tone, audience, maxRetries = 3) => {
  const apiUrl = `${GEMINI_API_URL}?key=${apiKey}`;

  // æ ¹æ® audience å‚æ•°æ„å»ºåŠ¨æ€çš„ System Instruction
  const audienceInstruction = audience.trim() 
    ? `ç‰¹åˆ«æ³¨æ„ï¼šä½ ç°åœ¨æ­£åœ¨ä¸ºç›®æ ‡å—ä¼— **${audience.trim()}** æ’°å†™æ–‡æ¡ˆã€‚ä½ å¿…é¡»ä½¿ç”¨é€‚åˆè¯¥ç¾¤ä½“ä½¿ç”¨çš„è¯­è¨€ã€æµè¡Œè¯­å’Œæ–‡åŒ–åå¥½ã€‚` 
    : "å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šç›®æ ‡å—ä¼—ï¼Œåˆ™ä½¿ç”¨é€šç”¨çš„ã€ä¸“ä¸šçš„ç¤¾äº¤åª’ä½“é£æ ¼ã€‚";

  // 1. æ„å»º System Instruction (é€šç”¨è§„åˆ™)
  const systemInstructionText = `
ä½ æ˜¯ä¸€ä½ä¸–ç•Œçº§çš„ç¤¾äº¤åª’ä½“æ–‡æ¡ˆä¸“å®¶å’Œå†…å®¹è¥é”€ç­–ç•¥å¸ˆã€‚
ä½ çš„ä»»åŠ¡æ˜¯å°†æä¾›çš„é•¿ç¯‡å†…å®¹æç‚¼ã€é‡å†™ï¼Œå¹¶è½¬æ¢æˆ 3 ä¸ªç‹¬ç‰¹çš„ã€é«˜è´¨é‡çš„ç¤¾äº¤åª’ä½“æ–‡æ¡ˆã€‚
æ ¸å¿ƒè§„åˆ™ï¼š
1. ä¸¥æ ¼éµå®ˆç›®æ ‡å¹³å°çš„å­—ç¬¦é™åˆ¶ï¼Œæ–‡æ¡ˆå¿…é¡»ç®€æ´ç²¾ç‚¼ã€‚
2. ä¸¥æ ¼éµå¾ªç”¨æˆ·æŒ‡å®šçš„è¯­æ°”å’Œé£æ ¼ã€‚
3. å¿…é¡»åœ¨æ¯ä¸ªæ–‡æ¡ˆä¸­åŠ å…¥ç›¸å…³çš„ #Hashtags æˆ– @æåŠï¼ˆå¦‚æœé€‚ç”¨ï¼‰ã€‚
4. å¿…é¡»å°†è¾“å‡ºæ ¼å¼åŒ–ä¸º JSON æ•°ç»„ï¼ŒåŒ…å« 3 ä¸ªç‹¬ç«‹çš„æ–‡æ¡ˆå¯¹è±¡ï¼š{text: string, image_prompt: string}ã€‚
5. æ–‡æ¡ˆå†…å®¹å¿…é¡»å¿ å®äºæºå†…å®¹çš„ä¸»æ—¨ã€‚
${audienceInstruction}
  `.trim();

  // 2. æ„å»º User Prompt (åŠ¨æ€æŒ‡ä»¤å’Œå†…å®¹)
  const userPromptText = `
è¯·å°†ä¸‹é¢çš„åŸå§‹å†…å®¹è½¬æ¢ä¸º 3 ä¸ªä¸åŒç‰ˆæœ¬çš„ç¤¾äº¤åª’ä½“æ–‡æ¡ˆã€‚

åŒæ—¶ï¼Œä¸ºæ¯ä¸ªæ–‡æ¡ˆç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„ã€é«˜è´¨é‡çš„**é…å›¾å›¾åƒç”Ÿæˆæç¤º (Image Prompt)**ï¼Œæè¿°æœ€é€‚åˆè¯¥æ–‡æ¡ˆçš„è§†è§‰å†…å®¹ã€‚å›¾åƒæç¤ºå†…å®¹è¯·ä½¿ç”¨**è‹±æ–‡**ï¼Œä»¥ä¾¿ç›´æ¥ç”¨äºå›¾åƒç”Ÿæˆæ¨¡å‹ã€‚

1. ç›®æ ‡å¹³å°æŒ‡ä»¤: ${platform.prompt}
2. è¯­æ°”é£æ ¼æŒ‡ä»¤: ${tone.prompt}
3. å†…å®¹å·®å¼‚åŒ–è¦æ±‚:
   - ç‰ˆæœ¬ 1: ä¾§é‡äºæ¸…æ™°ä¼ è¾¾ä¿¡æ¯ï¼Œå¹¶æä¾›ä¸€ä¸ªæ˜ç¡®çš„å·å¬è¡ŒåŠ¨ (CTA)ã€‚
   - ç‰ˆæœ¬ 2: ä¾§é‡äºäº’åŠ¨å’Œå‚ä¸ï¼Œä½¿ç”¨æé—®æˆ–äº‰è®®æ€§çš„è§‚ç‚¹æ¥å¸å¼•è¯„è®ºã€‚
   - ç‰ˆæœ¬ 3: ä¾§é‡äºæ€»ç»“å’Œäº®ç‚¹ï¼Œä½œä¸ºæœ€ç²¾ç®€ã€æœ€èƒ½æŠ“ä½çœ¼çƒçš„ç‰ˆæœ¬ã€‚

4. åŸå§‹å†…å®¹ (Source Content):
---
${content}
---

5. è¾“å‡ºæ ¼å¼è¦æ±‚: ä½ çš„å›ç­”å¿…é¡»æ˜¯ä¸€ä¸ª JSON æ•°ç»„ï¼ŒåŒ…å« 3 ä¸ªæ–‡æ¡ˆå¯¹è±¡ï¼š[{text: "...", image_prompt: "..."}, ...]ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„æ–‡æœ¬æˆ–è§£é‡Šã€‚
  `.trim();

  // 3. å®šä¹‰ JSON Schema (ç¡®ä¿ç»“æ„åŒ–è¾“å‡º)
  const responseSchema = {
    type: "ARRAY",
    description: "An array containing exactly three versions of the generated social media copy, each including the text and a detailed image prompt.",
    items: {
      type: "OBJECT",
      properties: {
        text: { type: "STRING", description: "The optimized social media copy." },
        image_prompt: { type: "STRING", description: "A detailed image generation prompt (in English) describing the best visual to accompany this copy." }
      },
      propertyOrdering: ["text", "image_prompt"]
    }
  };

  const payload = {
    contents: [{ parts: [{ text: userPromptText }] }],
    systemInstruction: { parts: [{ text: systemInstructionText }] },
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: responseSchema,
    },
  };

  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`API request failed with status ${response.status}`);
      }

      const result = await response.json();
      const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

      if (jsonText) {
        // 4. è§£æç»“æœ
        const parsedCopies = JSON.parse(jsonText);
        // æ£€æŸ¥æ•°ç»„é•¿åº¦å’Œå†…éƒ¨å¯¹è±¡ç»“æ„
        const isValidStructure = Array.isArray(parsedCopies) && parsedCopies.length === 3 &&
                                 parsedCopies.every(item => item && typeof item.text === 'string' && typeof item.image_prompt === 'string');

        if (isValidStructure) {
          // ç°åœ¨è¿”å›çš„æ˜¯å¯¹è±¡ {text, image_prompt}
          return parsedCopies.map((item, index) => ({
            id: index + 1,
            text: item.text,
            image_prompt: item.image_prompt,
            // é¢„ç•™å­—æ®µï¼Œç”¨äºå­˜å‚¨åç»­ç”Ÿæˆçš„å›¾åƒURL
            imageUrl: null, 
          }));
        } else {
          // å¦‚æœç»“æ„ä¸æ­£ç¡®ï¼Œè§†ä¸ºæ¨¡å‹å¤±è´¥
          throw new Error("AI output was not a 3-item JSON array of objects with 'text' and 'image_prompt'.");
        }
      } else {
        throw new Error("AI response content is empty.");
      }
    } catch (error) {
      console.error(`Attempt ${attempt + 1} failed:`, error);
      if (attempt < maxRetries - 1) {
        const delay = Math.pow(2, attempt) * 1000; // Exponential backoff
        await new Promise(resolve => setTimeout(resolve, delay));
      } else {
        throw new Error("AI generation failed after multiple retries. " + error.message);
      }
    }
  }
};

/**
 * å›¾åƒç”Ÿæˆå‡½æ•°ï¼Œè°ƒç”¨ Imagen 4.0 APIã€‚
 */
const generateImageWithImagen = async (prompt, maxRetries = 3) => {
  const apiUrl = `${IMAGEN_API_URL}?key=${apiKey}`;
  const payload = { 
    instances: { prompt: prompt }, 
    parameters: { 
      "sampleCount": 1,
      // å°çº¢ä¹¦å’Œç¤¾äº¤åª’ä½“å¸¸ç”¨çš„æ­£æ–¹å½¢æˆ–è¿‘æ­£æ–¹å½¢æ¯”ä¾‹
      "aspectRatio": "1:1", 
      "negativePrompt": "low quality, bad anatomy, deformed, worst quality, noise, blurry, watermark",
    } 
  };

  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`Image API request failed with status ${response.status}`);
      }

      const result = await response.json();
      
      const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
      
      if (base64Data) {
        return `data:image/png;base64,${base64Data}`;
      } else {
        throw new Error("Image generation failed, no image data returned.");
      }
    } catch (error) {
      console.error(`Image attempt ${attempt + 1} failed:`, error);
      if (attempt < maxRetries - 1) {
        const delay = Math.pow(2, attempt) * 1000; // Exponential backoff
        await new Promise(resolve => setTimeout(resolve, delay));
      } else {
        throw new Error("Image generation failed after multiple retries. " + error.message);
      }
    }
  }
};


// å¤åˆ¶åˆ°å‰ªè´´æ¿
const copyToClipboard = async (text, setter) => {
  try {
    // å…¼å®¹æ€§æ›´å¥½çš„å¤åˆ¶æ–¹å¼
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);

    setter(true);
    setTimeout(() => setter(false), 2000);
  } catch (err) {
    console.error('Failed to copy text: ', err);
  }
};

/**
 * ä¸‹è½½ Base64 Data URL å›¾åƒ
 */
const downloadImage = (dataUrl, filename = 'social_copy_image.png') => {
  const link = document.createElement('a');
  link.href = dataUrl;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};


// --- ç»„ä»¶å®šä¹‰ ---

// Platform Card (å¹³å°é€‰æ‹©å¡ç‰‡)
const PlatformCard = ({ platform, isSelected, onClick }) => {
  const Icon = platform.icon;
  return (
    <button
      onClick={() => onClick(platform)}
      className={`
        p-4 flex flex-col items-center justify-center rounded-lg transition-all duration-200 
        shadow-md hover:shadow-lg focus:outline-none focus:ring-4
        ${isSelected
          ? `${platform.color} text-white ring-offset-2 ring-opacity-50 ring-current transform scale-105`
          : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
        }
      `}
    >
      <Icon size={24} className="mb-2" />
      <span className="text-sm font-semibold">{platform.name}</span>
      <span className="text-xs opacity-70 mt-1">{platform.max}</span>
    </button>
  );
};

// Output Result Card (ç»“æœå±•ç¤ºå¡ç‰‡)
const ResultCard = ({ result, platform, updateResult }) => {
  const [copiedText, setCopiedText] = useState(false);
  const [copiedPrompt, setCopiedPrompt] = useState(false);
  const [copiedImageURL, setCopiedImageURL] = useState(false); // New state for image URL copy
  
  // New State for Image Generation in this card
  const [imageLoading, setImageLoading] = useState(false);
  const [imageError, setImageError] = useState(null);
  
  const charCount = result.text.length;
  const isOverLimit = charCount > platform.limit;

  const handleGenerateImage = useCallback(async () => {
    if (!result.image_prompt || imageLoading) return;
    
    setImageLoading(true);
    setImageError(null);
    setCopiedImageURL(false); // Reset URL copy state

    try {
      const url = await generateImageWithImagen(result.image_prompt);
      // è°ƒç”¨çˆ¶ç»„ä»¶å‡½æ•°æ›´æ–° state ä¸­çš„ imageUrl
      updateResult(result.id, url); 
    } catch (error) {
      console.error('Image generation error:', error);
      setImageError('å›¾åƒç”Ÿæˆå¤±è´¥: ' + error.message);
    } finally {
      setImageLoading(false);
    }
  }, [result.image_prompt, imageLoading, result.id, updateResult]);

  return (
    <div className="bg-gray-700 p-5 rounded-xl shadow-lg border border-gray-600 transition-all duration-300 hover:border-purple-500/50">
      
      {/* ç»“æœæ–‡æ¡ˆæ­£æ–‡ */}
      <div className="text-gray-200 whitespace-pre-wrap mb-4 h-32 overflow-y-auto custom-scrollbar">
        {result.text}
      </div>

      {/* çŠ¶æ€å’Œè®¡æ•°å™¨ (F-07) */}
      <div className="flex justify-between items-center text-sm mb-3 pt-3 border-t border-gray-600">
        <div className="flex space-x-4">
          <span className={`font-medium ${isOverLimit ? 'text-red-400' : 'text-purple-400'}`}>
            å­—æ•°: {charCount} / {platform.limit}
          </span>
          <span className="text-gray-400">
            é¢„ä¼°é˜…è¯»æ—¶é—´: {Math.max(1, Math.ceil(charCount / 60))} ç§’
          </span>
        </div>
      </div>
      
      {/* æ ¼å¼åŒ–é¢„è§ˆæç¤º (F-06) */}
      <p className="text-xs text-gray-500 italic mt-2 mb-4">
        *é¢„è§ˆï¼šè¯¥æ–‡æ¡ˆå·²é’ˆå¯¹ **{platform.name}** å¹³å°çš„æ’ç‰ˆä¹ æƒ¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚
      </p>

      {/* é…å›¾å»ºè®®åŒºåŸŸ */}
      <div className="mt-4 p-4 bg-gray-600/50 rounded-lg border border-gray-500">
          <h4 className="text-sm font-semibold text-purple-300 flex items-center mb-2">
              <Image size={16} className="mr-2" /> é…å›¾å»ºè®® (Image Prompt - è‹±æ–‡)
          </h4>
          <p className="text-xs text-gray-400 italic mb-3 break-words">
              {result.image_prompt || 'æœªæä¾›å›¾åƒæç¤º'}
          </p>
          <button
              onClick={() => copyToClipboard(result.image_prompt, setCopiedPrompt)}
              className={`w-full py-2 flex items-center justify-center rounded-lg text-sm font-bold transition duration-200
                  ${copiedPrompt
                      ? 'bg-green-600 text-white'
                      : 'bg-gray-500 hover:bg-gray-400 text-white'
                  }
              `}
              disabled={copiedPrompt || !result.image_prompt}
          >
              {copiedPrompt ? 'âœ… é…å›¾æç¤ºå·²å¤åˆ¶ï¼' : 'ä¸€é”®å¤åˆ¶é…å›¾æç¤º'}
          </button>
      </div>

      {/* å›¾åƒç”Ÿæˆå’Œæ˜¾ç¤ºåŒºåŸŸ (æ–°å¢) */}
      <div className="mt-4 pt-4 border-t border-gray-600">
        <h4 className="text-sm font-semibold text-white flex items-center mb-3">
          ğŸ–¼ï¸ å›¾åƒç”Ÿæˆ
        </h4>
        
        {!result.imageUrl && !imageLoading && (
          <button
              onClick={handleGenerateImage}
              className={`w-full py-2 flex items-center justify-center rounded-lg font-bold transition duration-200
                  ${!result.image_prompt ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600 text-white'}
              `}
              disabled={!result.image_prompt || imageLoading}
          >
              <Image size={16} className="mr-2" />
              æ ¹æ®æç¤ºç”Ÿæˆå›¾åƒ
          </button>
        )}

        {imageLoading && (
          <div className="flex items-center justify-center h-48 bg-gray-600 rounded-lg">
            <Loader size={24} className="animate-spin text-purple-400 mr-2" />
            <span className="text-sm text-purple-400">å›¾åƒç”Ÿæˆä¸­ (çº¦ 20-30 ç§’)...</span>
          </div>
        )}

        {imageError && (
            <div className="p-3 bg-red-800/50 text-red-300 rounded-lg text-sm">{imageError}</div>
        )}

        {result.imageUrl && (
          <div className="mt-3 relative">
            <img 
              src={result.imageUrl} 
              alt="AI Generated Visual for Copy" 
              className="w-full max-w-sm mx-auto rounded-lg shadow-xl" 
            />
            {/* æ–°å¢çš„å›¾ç‰‡æ“ä½œæŒ‰é’® */}
            <div className="flex space-x-2 mt-3 justify-center flex-wrap">
                {/* ä¸‹è½½æŒ‰é’® */}
                <button
                    onClick={() => downloadImage(result.imageUrl, `copy-image-${result.id}.png`)}
                    className="py-2 px-3 flex items-center rounded-lg text-sm font-bold bg-sky-500 hover:bg-sky-600 text-white transition duration-200 mt-2"
                >
                    <Download size={14} className="mr-1" /> ä¸‹è½½å›¾ç‰‡
                </button>
                
                {/* å¤åˆ¶ URL æŒ‰é’® */}
                <button
                    onClick={() => copyToClipboard(result.imageUrl, setCopiedImageURL)}
                    className={`py-2 px-3 flex items-center rounded-lg text-sm font-bold transition duration-200 mt-2 ${
                        copiedImageURL ? 'bg-green-600 text-white' : 'bg-gray-500 hover:bg-gray-400 text-white'
                    }`}
                >
                    {copiedImageURL ? 'âœ… URLå·²å¤åˆ¶' : 'å¤åˆ¶å›¾ç‰‡ URL'}
                </button>
                
                {/* é‡æ–°ç”ŸæˆæŒ‰é’® */}
                <button
                    onClick={handleGenerateImage} // Reusing the same handler
                    disabled={imageLoading}
                    className="py-2 px-3 flex items-center rounded-lg text-sm font-bold bg-purple-500 hover:bg-purple-600 text-white transition duration-200 mt-2"
                >
                    <RefreshCw size={14} className={`mr-1 ${imageLoading ? 'animate-spin' : ''}`} /> é‡æ–°ç”Ÿæˆ
                </button>
            </div>
            {copiedImageURL && <p className="text-xs text-green-400 mt-2 text-center">Base64 URL å·²å¤åˆ¶!</p>}
          </div>
        )}
      </div>


      {/* æ–‡æ¡ˆæ“ä½œæŒ‰é’® (F-08) */}
      <button
        onClick={() => copyToClipboard(result.text, setCopiedText)}
        className={`w-full py-2 flex items-center justify-center rounded-lg font-bold text-lg transition duration-200 mt-4
          ${copiedText
            ? 'bg-green-500 hover:bg-green-600 text-white'
            : 'bg-purple-600 hover:bg-purple-700 text-white'
          }
        `}
        disabled={copiedText}
      >
        {copiedText ? 'âœ… æ–‡æ¡ˆå·²å¤åˆ¶ï¼' : <><Clipboard size={16} className="mr-2" /> å¤åˆ¶æ–‡æ¡ˆ</>}
      </button>
    </div>
  );
};

// --- ä¸»åº”ç”¨ç»„ä»¶ ---
export default function App() {
  const [inputContent, setInputContent] = useState('');
  const [selectedPlatform, setSelectedPlatform] = useState(PLATFORMS[0]);
  const [selectedTone, setSelectedTone] = useState(TONES[0]);
  // ã€æ–°å¢çŠ¶æ€ã€‘ç”¨äºå­˜å‚¨ç›®æ ‡å—ä¼—æè¿°
  const [targetAudience, setTargetAudience] = useState('');
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);

  // F-07: å­—ç¬¦æ•°é™åˆ¶
  const MAX_CHARS = 5000;
  const charCount = inputContent.length;
  const isInputValid = charCount > 0 && charCount <= MAX_CHARS;

  // æ›´æ–°å•ä¸ªç»“æœå¡ç‰‡ä¸­çš„å›¾ç‰‡ URL
  const updateResultImageUrl = useCallback((id, url) => {
    setResults(prevResults =>
      prevResults.map(result =>
        result.id === id ? { ...result, imageUrl: url } : result
      )
    );
  }, []);

  // F-04: å¤„ç†ç”Ÿæˆæ–‡æ¡ˆé€»è¾‘
  const handleGenerate = useCallback(async () => {
    if (!isInputValid || loading) return;

    setLoading(true);
    setResults([]);
    try {
      // ä¼ é€’æ–°çš„ targetAudience å‚æ•°
      const generatedCopies = await generateCopyWithGemini(inputContent, selectedPlatform, selectedTone, targetAudience);
      setResults(generatedCopies);
    } catch (error) {
      console.error('AI generation failed:', error);
      // Failsafe for display
      setResults([{ id: 0, text: error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„è¾“å…¥æˆ–é‡è¯•ã€‚', image_prompt: 'æ— æ³•ç”Ÿæˆé…å›¾æç¤ºã€‚', imageUrl: null }]);
    } finally {
      setLoading(false);
    }
  }, [inputContent, selectedPlatform, selectedTone, targetAudience, isInputValid, loading]);

  // UI - å·¦ä¾§ï¼šè¾“å…¥ä¸é…ç½®é¢æ¿
  const InputConfigPanel = useMemo(() => (
    <div className="lg:w-1/3 p-6 bg-gray-800 rounded-xl shadow-2xl space-y-6 flex flex-col h-full">
      <h2 className="text-xl font-bold text-white border-b border-purple-500/50 pb-3">
        1. åŸå§‹å†…å®¹è¾“å…¥
      </h2>
      
      {/* F-01: æ–‡æœ¬è¾“å…¥åŒºåŸŸ */}
      <textarea
        className="w-full p-4 h-48 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-purple-500 focus:ring-purple-500 custom-scrollbar resize-none"
        placeholder="ç²˜è´´æ‚¨çš„æ–‡ç« ã€åšå®¢é“¾æ¥æˆ–é•¿æ–‡æœ¬ï¼ˆæœ€å¤š 5000 å­—ï¼‰..."
        value={inputContent}
        onChange={(e) => setInputContent(e.target.value)}
        maxLength={MAX_CHARS}
      />
      
      {/* å­—ç¬¦è®¡æ•°å’Œæ¸…é™¤æŒ‰é’® */}
      <div className="flex justify-between items-center text-sm">
        <span className={`font-medium ${charCount > MAX_CHARS ? 'text-red-400' : 'text-gray-400'}`}>
          å­—æ•°: {charCount} / {MAX_CHARS}
        </span>
        <button
          onClick={() => setInputContent('')}
          className="text-purple-400 hover:text-purple-300 transition duration-150"
        >
          æ¸…é™¤
        </button>
      </div>

      <h2 className="text-xl font-bold text-white border-b border-purple-500/50 pb-3 mt-4">
        2. ç›®æ ‡ä¸é£æ ¼é…ç½®
      </h2>
      
      {/* ã€æ–°å¢åŠŸèƒ½ã€‘ç›®æ ‡å—ä¼—è¾“å…¥ */}
      <div className="space-y-3">
        <label className="text-sm font-semibold text-gray-300 flex items-center">
          <Target size={16} className="mr-2 text-red-400" /> ç›®æ ‡å—ä¼—æè¿° (å¯é€‰ï¼Œä½†æ¨è)
        </label>
        <textarea
          className="w-full p-3 h-20 bg-gray-700 text-white rounded-lg border border-gray-600 focus:border-red-500 focus:ring-red-500 resize-none"
          placeholder="ä¾‹å¦‚ï¼š20-30 å²çš„å¥³æ€§ç™½é¢†ï¼Œå…³æ³¨æ—…è¡Œå’Œå¥åº·ç”Ÿæ´»ï¼›æˆ–ï¼šB2B ç§‘æŠ€å…¬å¸çš„ CEOã€‚"
          value={targetAudience}
          onChange={(e) => setTargetAudience(e.target.value)}
        />
      </div>


      {/* F-02: ç›®æ ‡å¹³å°é€‰æ‹© */}
      <div className="space-y-3 pt-4">
        <label className="text-sm font-semibold text-gray-300">ç›®æ ‡ç¤¾äº¤å¹³å°:</label>
        <div className="grid grid-cols-2 gap-4">
          {PLATFORMS.map((p) => (
            <PlatformCard
              key={p.id}
              platform={p}
              isSelected={selectedPlatform.id === p.id}
              onClick={setSelectedPlatform}
            />
          ))}
        </div>
      </div>

      {/* F-03: æ–‡æ¡ˆè¯­æ°”é€‰æ‹© */}
      <div className="space-y-3 pt-4">
        <label className="text-sm font-semibold text-gray-300">æ–‡æ¡ˆè¯­æ°”/é£æ ¼:</label>
        <div className="grid grid-cols-3 gap-4">
          {TONES.map((t) => (
            <button
              key={t.id}
              onClick={() => setSelectedTone(t)}
              className={`
                p-3 flex flex-col items-center justify-center rounded-lg text-sm transition-all duration-200 
                ${selectedTone.id === t.id
                  ? 'bg-purple-600 text-white ring-2 ring-purple-400'
                  : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                }
              `}
            >
              <t.icon size={18} className="mb-1" />
              {t.name}
            </button>
          ))}
        </div>
      </div>

      {/* F-04: ä¸»æ“ä½œæŒ‰é’® */}
      <button
        onClick={handleGenerate}
        disabled={!isInputValid || loading}
        className={`
          w-full py-4 rounded-xl font-extrabold text-lg flex items-center justify-center mt-6 transition-all duration-300
          ${isInputValid && !loading
            ? 'bg-purple-500 hover:bg-purple-400 text-white shadow-lg shadow-purple-500/50 transform hover:scale-[1.01]'
            : 'bg-gray-600 text-gray-400 cursor-not-allowed'
          }
        `}
      >
        {loading ? (
          <><Loader size={20} className="animate-spin mr-2" /> AI æ­£åœ¨æ€è€ƒä¸­...</>
        ) : (
          <><Send size={20} className="mr-2" /> ç”Ÿæˆ Social æ–‡æ¡ˆå’Œé…å›¾å»ºè®®</>
        )}
      </button>
    </div>
  ), [inputContent, selectedPlatform, selectedTone, targetAudience, loading, isInputValid, charCount, handleGenerate]);


  // UI - å³ä¾§ï¼šç»“æœé¢æ¿
  const OutputPanel = useMemo(() => (
    <div className="lg:w-2/3 p-6 space-y-6">
      <h2 className="text-xl font-bold text-white border-b border-purple-500/50 pb-3">
        3. AI ç”Ÿæˆç»“æœ ({selectedPlatform.name} é£æ ¼)
      </h2>

      {loading && (
        <div className="text-center p-10 bg-gray-800 rounded-xl text-purple-400">
          <Loader size={32} className="animate-spin mx-auto mb-4" />
          <p>æ­£åœ¨æ ¹æ®æ‚¨çš„é…ç½®å’Œå†…å®¹ï¼Œç”Ÿæˆ 3 ç§ä¸åŒçš„æ–‡æ¡ˆç‰ˆæœ¬ä»¥åŠé…å›¾å»ºè®®...</p>
        </div>
      )}

      {!loading && results.length === 0 && (
        <div className="text-center p-10 bg-gray-800 rounded-xl text-gray-500 border border-dashed border-gray-600">
          <Sparkles size={32} className="mx-auto mb-4" />
          <p>è¯·åœ¨å·¦ä¾§è¾“å…¥å†…å®¹å¹¶é…ç½®ç›®æ ‡å¹³å°å’Œè¯­æ°”ï¼Œå¼€å§‹ç”Ÿæˆã€‚</p>
        </div>
      )}

      {/* ç»“æœå¡ç‰‡åˆ—è¡¨ (F-05) */}
      <div className="grid gap-6">
        {results.map((result, index) => (
          <ResultCard
            key={result.id}
            result={result}
            platform={selectedPlatform}
            updateResult={updateResultImageUrl}
          />
        ))}
      </div>
    </div>
  ), [loading, results, selectedPlatform, updateResultImageUrl]);


  // ä¸»æ¸²æŸ“ç»“æ„
  return (
    <div className="min-h-screen bg-gray-900 font-inter p-4 sm:p-8">
      {/* å¤´éƒ¨æ ‡é¢˜ */}
      <header className="mb-8 text-center">
        <h1 className="text-4xl font-extrabold text-white flex items-center justify-center">
          <Zap size={32} className="text-purple-400 mr-3" />
          SocialCopy AI <span className="text-lg font-light ml-3 text-gray-500">(MVP)</span>
        </h1>
        <p className="text-gray-400 mt-2">å°†æ‚¨çš„é•¿ç¯‡å†…å®¹ä¸€é”®è½¬æ¢ä¸ºé’ˆå¯¹ç¤¾äº¤åª’ä½“ä¼˜åŒ–çš„ç²¾ç‚¼æ–‡æ¡ˆã€é…å›¾å»ºè®®ï¼Œå¹¶å¯**ç›´æ¥ç”Ÿæˆå›¾åƒ**ã€‚</p>
      </header>
      
      {/* æ ¸å¿ƒä¸¤æ /å †å å¸ƒå±€ */}
      <main className="flex flex-col lg:flex-row gap-6 max-w-7xl mx-auto">
        {/* å·¦ä¾§è¾“å…¥ä¸é…ç½® */}
        {InputConfigPanel}
        
        {/* å³ä¾§ç»“æœè¾“å‡º */}
        {OutputPanel}
      </main>

      {/* æ»šåŠ¨æ¡ç¾åŒ– CSS (è‡ªå®šä¹‰æ ·å¼) */}
      <style>{`
        /* Custom Scrollbar for better UX */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #6b46c1; /* Purple-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #374151; /* Gray-700 */
            border-radius: 4px;
        }
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #6b46c1 #374151;
        }
      `}</style>
    </div>
  );
}